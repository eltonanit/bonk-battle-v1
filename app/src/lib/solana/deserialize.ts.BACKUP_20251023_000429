import { PublicKey } from '@solana/web3.js';

export function deserializeTokenLaunch(data: Buffer, pubkey?: PublicKey) {
  try {
    if (!pubkey) {
      console.error('❌ pubkey undefined!');
      return null;
    }

    let offset = 8;

    // 🔧 FIX: Convert to string immediately
    const creator = new PublicKey(data.slice(offset, offset + 32)).toString();
    offset += 32;

    const mint = new PublicKey(data.slice(offset, offset + 32)).toString();
    offset += 32;

    const tier = data.readUInt8(offset);
    offset += 1;

    const virtualSolInit = Number(data.readBigUInt64LE(offset)) / 1e9;
    offset += 8;

    const constantKLow = data.readBigUInt64LE(offset);
    offset += 8;
    const constantKHigh = data.readBigUInt64LE(offset);
    offset += 8;
    const constantK = (constantKHigh << 64n) | constantKLow;

    const targetSol = Number(data.readBigUInt64LE(offset)) / 1e9;
    offset += 8;

    const deadline = Number(data.readBigInt64LE(offset));
    offset += 8;

    const solRaised = Number(data.readBigUInt64LE(offset)) / 1e9;
    offset += 8;

    const status = data.readUInt8(offset);
    offset += 1;
    
    const createdAt = Number(data.readBigInt64LE(offset));
    offset += 8;

    const hasGraduatedAt = data.readUInt8(offset) === 1;
    offset += 1;
    let graduatedAt = null;
    if (hasGraduatedAt) {
      graduatedAt = Number(data.readBigInt64LE(offset));
      offset += 8;
    }

    const hasMeteora = data.readUInt8(offset) === 1;
    offset += 1;
    let meteoraPool = null;
    if (hasMeteora) {
      meteoraPool = new PublicKey(data.slice(offset, offset + 32)).toString();
      offset += 32;
    }

    const totalBuyers = data.readUInt32LE(offset);
    offset += 4;

    const totalTokensSold = Number(data.readBigUInt64LE(offset)) / 1e6;
    offset += 8;

    const holdersThawed = data.readUInt32LE(offset);
    offset += 4;

    const nameLength = data.readUInt32LE(offset);
    offset += 4;
    const name = data.slice(offset, offset + nameLength).toString('utf8').trim();
    offset += nameLength;

    const symbolLength = data.readUInt32LE(offset);
    offset += 4;
    const symbol = data.slice(offset, offset + symbolLength).toString('utf8').trim();
    offset += symbolLength;

    const uriLength = data.readUInt32LE(offset);
    offset += 4;
    const metadataUri = data.slice(offset, offset + uriLength).toString('utf8').trim();
    offset += uriLength;

    const bump = data.readUInt8(offset);

    return {
      pubkey: pubkey.toString(), // 🔧 String
      creator, // 🔧 String
      mint, // 🔧 String
      tier,
      virtualSolInit,
      constantK: constantK.toString(),
      targetSol,
      deadline,
      solRaised,
      status,
      createdAt,
      graduatedAt,
      meteoraPool, // 🔧 String or null
      totalBuyers,
      totalTokensSold,
      holdersThawed,
      name,
      symbol,
      metadataUri,
      bump
    };
  } catch (error) {
    console.error('❌ Deserialize error:', error);
    return null;
  }
}

export interface TokenLaunchData {
  pubkey: string; // 🔧 Changed from PublicKey
  creator: string; // 🔧 Changed from PublicKey
  mint: string; // 🔧 Changed from PublicKey
  tier: number;
  virtualSolInit: number;
  constantK: string;
  targetSol: number;
  deadline: number;
  solRaised: number;
  status: number;
  createdAt: number;
  graduatedAt: number | null;
  meteoraPool: string | null; // 🔧 Changed from PublicKey
  totalBuyers: number;
  totalTokensSold: number;
  holdersThawed: number;
  name: string;
  symbol: string;
  metadataUri: string;
  bump: number;
}
